/**
 * Created by Administrator on 2017/3/13.
 */

//  当前分类导航是否开启转态
var categorySwitchFlag = 0;     //  1 => 开启， 0 => 关闭
//  是否编辑成功状态变量
var editState = "";
//  当前显示订阅数状态
var sub_status = 1;            //  1 => 隐藏（关闭）， 0 => 不隐藏(开启)

//消息提醒开关
var msg_alert = 1;              //  0-不开启  1-开启',
//显示专栏期数
var sub_per_num = 1;          //  1开启  0关闭；

$(document).ready(function () {
    categorySwitchFlag = $(".resource_category_data").data("resource_category");
    editState = $(".edit_state_data").data("edit_state");
    sub_status = $(".resource_subscribe").data("subscribe");
    msg_alert = $(".msg_alert_data").data("msg_alert");
    sub_per_num =$(".subscribe_per_num").data("per_num")
    $manageFunction.init();

});

$manageFunction = {

    init: function () {

        //  初始化分类导航转态开关
        if (categorySwitchFlag == 1) {          //已经开启状态
            $manageFunction.showCategory(1);
        } else {
            $manageFunction.hideCategory(1);
        }
        //  初始化订阅数开关状态
        if (sub_status == 0) {          //已经隐藏状态
            $manageFunction.showCategory(2);
        } else {
            $manageFunction.hideCategory(2);
        }
        //  初始化消息提醒开关
        if (msg_alert == 1) {           //已经开启消息提醒
            $manageFunction.showCategory(3);
        } else {
            $manageFunction.hideCategory(3);
        }
        if (sub_per_num == 1) {           //已经开启期数显示（具体待定）
            $manageFunction.showCategory(4);
        } else {
            $manageFunction.hideCategory(4);
        }

        //  初始化时查看是否编辑成功
        if (editState == "finish_edit") {
            baseUtils.show.blueTip("分类导航编辑完成!");
        }

        //  点击切换分类导航开关
        $("#category_navigation_switch").click(function () {
            if (categorySwitchFlag == 1) {      //  关闭分类导航
                $.alert("关闭分类导航后，分类将会隐藏，所有内容均展示在首页", "info", {
                    btn: 3,
                    oktext: "确认关闭",
                    onOk: function () {
                        $.ajax("/category_switch",{
                            type: "POST",
                            dataType: "json",
                            data: {type: 0},
                            success: function (data) {
                                if (data.ret == 0) {        //  关闭分类导航成功 - 显示提示
                                    categorySwitchFlag = 0;
                                    $manageFunction.hideCategory(1);
                                    baseUtils.show.blueTip("分类导航已隐藏！");
                                } else {
                                    if (data.msg != "" && data.msg != undefined) {
                                        baseUtils.show.redTip(data.msg);
                                    } else {
                                        baseUtils.show.redTip("关闭分类导航失败！");
                                    }
                                }
                            },
                            error: function (xhr, status, err) {
                                hideLoading();
                                $manageFunction.showCategory(1);         //  关闭失败，开关恢复为显示
                                console.error(err);
                                baseUtils.show.redTip("网络错误，请稍后再试！");
                            }
                        });
                    },
                });

            } else {                            //  打开分类导航
                showLoading();

                $.ajax('/category_switch',{
                    type:"POST",
                    dataType:"json",
                    data:{type: 1},
                    success: function (data) {
                        hideLoading();

                        if (data.ret == 0) {        //  开启分类导航成功 - 显示提示
                            categorySwitchFlag = 1;
                            $.alert("已成功开启首页分类导航，您现在可以在编辑专栏时选择专栏的所属分类了", "info", {
                                btn: 2,
                            });
                            $manageFunction.showCategory(1);
                        } else {
                            if (data.msg != "" && data.msg != undefined) {  //失败原因 - - 未完成分类导航的编辑
                                $.alert("您还未完成首页分类导航的编辑，暂时无法开启该功能", "info", {
                                    btn: 3,
                                    onOk: function () { //立即编辑
                                        window.location.href = '/category_setting';
                                    },
                                });
                            } else {                                        //失败原因 - - 其它错误
                                baseUtils.show.redTip("开启分类导航失败！");
                            }
                        }
                    },
                    error: function (xhr, status, err) {
                        hideLoading();
                        console.error(err);
                        baseUtils.show.redTip("网络错误，请稍后再试！");
                    }
                });
            }
        });


        //  首页分类导航 > 编辑页面
        $(".function_edit").click(function () {
            window.location.href = "/category_setting";
        });

        //显示or隐藏用户订阅数
        $("#subscribe_switch").on('click',function(){
            // console.log('the test')
            var version=$(".user_version_num").data("version_type");
            if(version && version==3) {
                if (sub_status == 0) {
                    $.alert("关闭后用户将无法看到商品订阅数", "error", {//隐藏订阅数显示
                        title: "提示",
                        icon: 'blue',
                        btn: 3,
                        onOk: function () {
                            $.ajax("/set_hid_sub", {
                                type: "POST",
                                dataType: "json",
                                data: {status: 0},
                                success: function (data) {
                                    console.log(data);
                                    if (data.code == 0) {
                                        baseUtils.show.blueTip("关闭成功！");
                                        $manageFunction.hideCategory(2);
                                        sub_status = 1;//避免刷新页面处理
                                    } else {
                                        baseUtils.show.redTip("关闭失败！");
                                        $manageFunction.showCategory(2)
                                    }
                                },
                                error: function (xhr, status, err) {
                                    hideLoading();
                                    $manageFunction.showCategory(2);         //  关闭失败，开关恢复为显示
                                    console.error(err);
                                    baseUtils.show.redTip("网络错误，请稍后再试！");
                                }
                            })
                        }
                    })
                } else if (sub_status == 1) {//开启订阅数显示
                    $.alert("开启后您的用户可以看到商品的订阅数", "success", {//隐藏订阅数显示
                        title: "提示",
                        icon: 'blue',
                        btn: 3,
                        onOk: function () {
                            $.ajax("/set_hid_sub", {
                                type: "POST",
                                dataType: "json",
                                data: {status: 1},
                                success: function (data) {
                                    console.log(data);
                                    if (data.code == 0) {
                                        baseUtils.show.blueTip("开启成功！");
                                        $manageFunction.showCategory(2);
                                        sub_status = 0;
                                    } else {
                                        baseUtils.show.redTip("开启失败！");
                                        $manageFunction.hideCategory(2)
                                    }
                                },
                                error: function (xhr, status, err) {
                                    hideLoading();
                                    $manageFunction.showCategory(2);         //  开启失败，开关恢复为显示
                                    console.error(err);
                                    baseUtils.show.redTip("网络错误，请稍后再试！");
                                }
                            })
                        }
                    })
                }
            }else{
                baseUtils.show.redTip("当前版本不支持订阅量展示控制功能，如需使用请升级至专业版");
            }
        });


        //消息提醒开关
        $("#msg_alert_switch").click(function () {
            $.ajax("/set_alert_message", {
                type: "POST",
                dataType: "json",
                data: {},
                success: function (result) {
                    if (result.code == 0) {
                        if (msg_alert == 1) {       //当前状态 - 开启
                            baseUtils.show.blueTip("已关闭消息提醒");
                            $manageFunction.hideCategory(3);
                            msg_alert = 0;

                        } else {
                            baseUtils.show.blueTip("已开启消息提醒");
                            $manageFunction.showCategory(3);
                            msg_alert = 1;
                        }
                    } else {
                        baseUtils.show.redTip("关闭失败，请稍后再试。");
                    }
                },
                error: function (xhr, status, err) {
                    console.log(err);
                    baseUtils.show.redTip("服务器出小差了，请稍后再试！");
                }
            });

        });

        //显示or隐藏专栏会员期数
        $("#subscribe_per_num").on('click',function(){
            console.log('the test')
            var version=$(".user_version_num").data("version_type");
            if(version && version==3) {
                if (sub_per_num == 1) {
                    $.alert("关闭后用户将无法看到商品的更新期数", "error", {//隐藏订阅数显示
                        title: "提示",
                        icon: 'blue',
                        btn: 3,
                        onOk: function () {
                            $.ajax("/set_resource_count", {
                                type: "POST",
                                dataType: "json",
                                data: {status: 0},
                                success: function (data) {
                                    console.log(data);
                                    if (data.code == 0) {
                                        baseUtils.show.blueTip("关闭成功！");
                                        $manageFunction.hideCategory(4);
                                        sub_per_num = 0;//避免刷新页面处理
                                    } else {
                                        baseUtils.show.redTip("关闭失败！");
                                        $manageFunction.showCategory(4)
                                    }
                                },
                                error: function (xhr, status, err) {
                                    hideLoading();
                                    $manageFunction.showCategory(4);         //  关闭失败，开关恢复为显示
                                    console.error(err);
                                    baseUtils.show.redTip("网络错误，请稍后再试！");
                                }
                            })
                        }
                    })
                } else if (sub_per_num == 0) {//开启订阅数显示
                    $.alert("开启后您的用户可以看到商品的更新期数", "success", {
                        title: "提示",
                        icon: 'blue',
                        btn: 3,
                        onOk: function () {
                            $.ajax("/set_resource_count", {
                                type: "POST",
                                dataType: "json",
                                data: {status: 1},
                                success: function (data) {
                                    console.log(data);
                                    if (data.code == 0) {
                                        baseUtils.show.blueTip("开启成功！");
                                        $manageFunction.showCategory(4);
                                        sub_per_num = 1;
                                    } else {
                                        baseUtils.show.redTip("开启失败！");
                                        $manageFunction.hideCategory(4)
                                    }
                                },
                                error: function (xhr, status, err) {
                                    hideLoading();
                                    $manageFunction.showCategory(4);         //  开启失败，开关恢复为显示
                                    console.error(err);
                                    baseUtils.show.redTip("网络错误，请稍后再试！");
                                }
                            })
                        }
                    })
                }
            }else{
                baseUtils.show.redTip("当前版本不支持更新期数展控制功能，如需使用请升级至专业版");
            }
        });
    },


    //  显示分类导航,订阅数样式控制方法
    showCategory: function(status) {
        var s_btn,s_icon,s_desc, showText;
        if(status==1){//当按钮为显示首页分页导航时
            s_btn=$(".nav_switch_btn");
            s_icon=$(".nav_switch_icon");
            s_desc=$(".nav_switch_desc");
            showText = "显示";
        }else if(status==2){//当按钮为显示用户订阅数时
            s_btn=$(".sub_switch_btn");
            s_icon=$(".sub_switch_icon");
            s_desc=$(".sub_switch_desc");
            showText = "开启";
        } else if (status == 3) {
            s_btn=$(".msg_remind_switch_btn");
            s_icon=$(".msg_remind_switch_icon");
            s_desc=$(".msg_remind_switch_desc");
            showText = "开启";
        }else if(status == 4){
            s_btn=$(".sub_per_btn");
            s_icon=$(".sub_per_icon");
            s_desc=$(".sub_per_desc");
            showText = "开启";
        }

        //打开开关样式
        s_btn.removeClass("function_switch_off");
        s_btn.removeClass("function_switch_on");
        s_btn.addClass("function_switch_on");
        s_desc.removeClass("function_switch_desc_off");
        s_desc.removeClass("function_switch_desc_on");
        s_desc.addClass("function_switch_desc_on");
        s_icon.removeClass("switch_button_icon_off");
        s_icon.removeClass("switch_button_icon_on");
        s_icon.addClass("switch_button_icon_on");
        s_desc.html(showText);
    },

    //  隐藏分类导航，订阅数样式控制方法
    hideCategory: function(status) {
        var s_btn,s_icon,s_desc, showText;
        if(status==1){//当按钮为显示首页分页导航时
            s_btn=$(".nav_switch_btn");
            s_icon=$(".nav_switch_icon");
            s_desc=$(".nav_switch_desc");
            showText = "隐藏";
        }else if(status==2){//当按钮为显示用户订阅数时
            s_btn=$(".sub_switch_btn");
            s_icon=$(".sub_switch_icon");
            s_desc=$(".sub_switch_desc");
            showText = "关闭";
        }else if (status == 3) {
            s_btn=$(".msg_remind_switch_btn");
            s_icon=$(".msg_remind_switch_icon");
            s_desc=$(".msg_remind_switch_desc");
            showText = "关闭";
        }else if(status == 4){
            s_btn=$(".sub_per_btn");
            s_icon=$(".sub_per_icon");
            s_desc=$(".sub_per_desc");
            showText = "关闭";
        }

        // 关闭开关样式
        s_btn.removeClass("function_switch_off");
        s_btn.removeClass("function_switch_on");
        s_btn.addClass("function_switch_off");
        s_desc.removeClass("function_switch_desc_off");
        s_desc.removeClass("function_switch_desc_on");
        s_desc.addClass("function_switch_desc_off");
        s_icon.removeClass("switch_button_icon_off");
        s_icon.removeClass("switch_button_icon_on");
        s_icon.addClass("switch_button_icon_off");
        s_desc.html(showText);
    },

};













