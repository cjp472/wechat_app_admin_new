/**
 * Created by Administrator on 2017/8/2.
 */


$(document).ready(function () {
    $currentObj.init();
});

$currentObj = (function () {
    var $currentObj = {
        monitorAudioObj: -1,
    };
    var $private = {

    };
    $currentObj.init = function () {

        //作业的操作
        $(".operateList > li.operate").click(function () {
            var $self = $(this),
                $parent = $self.parents(".exerciseOperateArea"),
                type = $self.data("type"),
                resId = $parent.data("resource_id"),
                resType = $parent.data("resource_type"),
                exerciseId = $parent.data("exercise_id"),
                textContent = $parent.data("text_content"),
                imgUrlsArr = $parent.data("img_urls"),
                audioUrlsArr = $parent.data("audio_urls"),
                exerciseTitle = $parent.data("exercise_title");

            $private = {
                textContent: textContent,
                imgUrlsArr: imgUrlsArr,
                audioUrlsArr: audioUrlsArr,
                exerciseTitle: exerciseTitle
            };

            switch (type) {
                case "look_exercise_content":
                    lookExerciseContent();
                    break;
                case "delete_exercise":
                    showConfirmWindow(exerciseId);
                    break;
                default:
                    console.log("参数错误");
                    break;
            }
        });

        /*********************** 处理详情窗口 *************************/
        $("#closeExeDetailWindow").click(function () {
            baseUtils.hideWindow("lookExerciseDetailWindow");
        });

        //  播放/暂停 音频
        $("#audioContentArea").on("click", ".audioPlayStateIcon", function () {
            var $self = $(this),
                $target = $self.parents(".audioController").siblings(".audioDom")[0],
                isAudioPlaying = $self.hasClass("playing");

            if (isAudioPlaying) {
                $target.pause();
            } else {
                $target.play();
            }
        });

        $("#closeExeDetailWindow").click(function () {
            $("#audioContentArea").html("");
        });

    };
    function playAudioEvent(k, v) {
        clearInterval($currentObj.monitorAudioObj);
        $currentObj.monitorAudioObj = setInterval(monitorAudio, 500, k, v);
        $("#audioContentArea").find(".audioPlayStateIcon")
            .eq(k).removeClass("paused").addClass("playing");
    };
    function pauseAudioEvent(k, v, isEnded) {
        if (isEnded) {
            v.currentTime = 0;
            $("#audioContentArea").find(".finishedProgress").eq(k).css({"width": "0%"});
        }
        clearInterval($currentObj.monitorAudioObj);
        $("#audioContentArea").find(".audioPlayStateIcon")
            .eq(k).removeClass("playing").addClass("paused");
    };
    function monitorAudio(k, v) {
        var current = v.currentTime,
            duration = v.duration,
            progressWidth = 100 * (current / duration);

        $("#audioContentArea").find(".finishedProgress").eq(k).css({"width": progressWidth+"%"});
        // $("#audioContentArea").find(".progressBarDot").eq(k).css({"left": progressWidth+"%"});
    };
    function lookExerciseContent() {

        //填充数据
        $("#windowHeader").text($private.exerciseTitle);

        $("#textContentArea").text($private.textContent);

        if ($private.imgUrlsArr.length > 0) {
            var imgContentHtml = "";
            $.each($private.imgUrlsArr, function (k, v) {
                imgContentHtml +=
                    '<div class="singleExeImg">'+
                        '<img src="'+v+'">'+
                    '</div>';
            });
            $("#imgContentArea").html(imgContentHtml);
        } else {
            $("#imgContentArea").html("");
        }
        if ($private.audioUrlsArr.length > 0) {
            var audioContentHtml = "";
            $.each($private.audioUrlsArr, function (k, v) {
                audioContentHtml +=
                        '<div class="singleExeAudio">'+
                            '<audio class="audioDom" src="'+v+'"></audio>'+
                            '<div class="audioController">'+
                                '<div class="audioPlayStateIcon paused"></div>'+
                                '<div class="progressBar">'+
                                    '<span class="finishedProgress"></span>'+
                                '</div>'+
                                '<div class="audioLengthSecond"><span></span>"</div>'+
                            '</div>'+
                        '</div>';
            });
            $("#audioContentArea").html(audioContentHtml);
        } else {
            $("#audioContentArea").html("");
        }

        baseUtils.showWindow("lookExerciseDetailWindow");

        $.each(document.getElementsByTagName("audio"), function (k, v) {
            //开始播放
            v.addEventListener("playing", function () {
                playAudioEvent(k, v);
            });
            v.addEventListener("play", function () {
                playAudioEvent(k, v);
            });
            v.addEventListener("pause", function () {
                pauseAudioEvent(k, v);
            });
            v.addEventListener("ended", function () {
                pauseAudioEvent(k, v, true);
            });
            //初始化audio时长
            v.addEventListener("canplay", function () {
                $("#audioContentArea").find(".audioLengthSecond>span")
                    .eq(k).text(parseInt(v.duration));
            })
        });
    };
    function showConfirmWindow(exerciseId) {
        $.alert("是否确认删除", {
            btn: 3,
            onOk: function () {
                deleteExercise(exerciseId);
            },
        });
    }
    function deleteExercise(exerciseId) {
        $.ajax("/exercise/change_exercise_state", {
            type: "POST",
            dataType: "json",
            data: {
                state: 2,
                exercise_id: exerciseId,
                exercise_book_id: GetQueryString("exercise_book_id"),
            },
            success: function (result) {
                if (result.code == 0) {
                    baseUtils.show.blueTip("删除成功");
                    window.location.reload();
                } else {
                    alert("网络问题，请稍后再试");
                }
            },
            error: function (xhr, status, err) {
                console.log(err);
                alert("服务器出小差了，请稍后再试！");
            }
        });
    };

    return $currentObj;
})();












