/**
 * Created by Administrator on 2017/7/31.
 */

$(document).ready(function () {
    $manageExercise.init();
});

$manageExercise = (function () {
    var $manageExercise = {


    };
    var submitLimit = false;

    $manageExercise.init = function () {

        //点击侧边栏离开时的弹框
        changeSaveFlag(true);

        $("#exerciseBookName").on("keyup", function () {
            var $self = $(this),
                exerciseName = $.trim($self.val());

            if (exerciseName.length >= 14) {
                exerciseName = exerciseName.substr(0, 14);
                $self.val(exerciseName);
                $(".characterNumLimit").css({"color": "red"});
                setTimeout(function () {
                    $(".characterNumLimit").css({"color": "#888888"});
                }, 3000);
            }
            $(".characterNumLimit>span").text(exerciseName.length);
        });

        //关联课程
        $("#resTypeSelector").on("change", function () {
            var resType = $(this).val();
            if (resType == -1) {
                $("#resItemSelector").html(
                    ' <option value="-1">请选择具体课程</option>'
                );
            } else {
                $.ajax("/exercise/get_resource_list", {
                    type: "POST",
                    dataType: "json",
                    data: {
                        resource_type: resType
                    },
                    success: function (result) {
                        if (result.code == 0) {
                            var resourceList = result.data.resource_list,
                                htmlStr = "";
                            $.each(resourceList, function (k, v) {
                                var resName = (resType==5?v.name:v.title);
                                htmlStr +=
                                    '<option value="'+v.id+'">'+resName+'</option>';
                            });
                            if (htmlStr.length == 0) {
                                htmlStr =
                                    ' <option value="-1">暂无数据</option>';
                            }
                            $("#resItemSelector").html(htmlStr);

                        } else {
                            baseUtils.show.redTip("网络问题，请稍后再试");
                        }
                    },
                    error: function (xhr, status, err) {
                        console.log(err);
                        alert("服务器出小差了，请稍后再试！");
                    }
                });
            }

        });

        // radio 按钮点击切换效果
        $('.remindRadio').on('click', function() {
            $('.remindRadio').children('.circleRadio').removeClass('radioActive');
            $(this).children('.circleRadio').addClass('radioActive');
        });

        $("#cancelSaveExercise").click(function () {
            window.history.back();
        });

        $("#confirmSaveExercise").click(function () {
            var exerciseBookName = $.trim($("#exerciseBookName").val()),
                resId = $("#resItemSelector").val(),
                resType = $("#resTypeSelector").val(),
                resName = $("#resItemSelector > option:selected").text(),
                communityId = $("#communitySelector").val(),
                isRemind = $(".circleRadio.radioActive").data("is_remind"), // 1 - 提醒， 0 - 不提醒<默认不提醒>
                pageType = $("#admin_data").val(),
                postUrl = "";

            isRemind = 0;   //  TODO 暂时先设置为不提醒

            if (exerciseBookName.length == 0) {
                baseUtils.show.redTip("还没有输入作业本名称");
                return false;
            }
            if (exerciseBookName.length > 14) {
                baseUtils.show.redTip("作业本名称长度不能超过14字");
                return false;
            }
            if (resId == -1) {
                baseUtils.show.redTip("还没有选择具体课程");
                return false;
            }

            var params = {
                title: exerciseBookName,
                resource_id: resId,
                resource_type: resType,
                resource_name: resName,
                is_enable_notify: isRemind
            }
            if (communityId != -1 && communityId != undefined) {
                params.community_id = communityId;
            }
            if (pageType == 0) {//创建
                postUrl = "/exercise/upload_exercise_book";
            } else {//编辑
                postUrl = "/exercise/update_exercise_book";
                params.exercise_book_id = GetQueryString("exercise_book_id");
            }
            if (submitLimit) {
                baseUtils.show.redTip("正在提交中，请稍后再试");
                return false;
            }
            submitLimit = true;
            $.ajax(postUrl, {
                type: "POST",
                dataType: "json",
                data: {
                    params: params
                },
                success: function (result) {
                    submitLimit = false;
                    if (result.code == 0) {
                        baseUtils.show.blueTip("创建作业本成功");
                        setTimeout(function () {
                            window.location.href = "/exercise/exercise_book_list";
                        }, 1000);
                    } else {
                        alert("网络问题，请稍后再试");
                    }
                },
                error: function (xhr, status, err) {
                    submitLimit = false;
                    console.log(err);
                    alert("服务器出小差了，请稍后再试！");
                }
            });

        });

    };

    return $manageExercise;
})();




















