<?php

namespace App\Http\Middleware;

use App\Http\Controllers\Tools\AppUtils;
use App\Http\Controllers\Tools\Utils;
use Closure;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;

/**
 * 图片压缩中间件
 * Class ImageDealMiddleware
 * @package App\Http\Middleware
 */
class ImageDealMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle($request, Closure $next)
    {
        return $next($request);
    }

    /**
     * request->image_list 图片列表
     * @param $request
     * @param $response
     */
    public function terminate($request, $response){
        $img_list = $request->image_list;
        if (!empty($img_list) && is_array($img_list) && count($img_list) > 0) {
            foreach ($img_list as $item) {
                $imageObj = $item;

                if (!empty($imageObj) && is_object($imageObj)) {
                    $table_name = $imageObj->table_name;
                    $app_id = $imageObj->app_id;
                    $id = $imageObj->id;
                    $image_url = $imageObj->image_url;
                    $image_width = $imageObj->image_width;
                    $image_height = $imageObj->image_height;
                    $image_quality = $imageObj->image_quality;
                    Utils::logFrom($table_name." ".$app_id." ".$id, "ImageDealMiddleware.log");

                    //下载原图
                    $src_image = Utils::downloadFileFromNet($image_url);
                    //压缩处理
                    $tar_image = Utils::imageCompressd($src_image, $image_width, $image_height, $image_quality);
                    //上传压缩图
                    $img_url_compressed = Utils::uploadCompressImage($tar_image, $app_id);
                    //更新数据库
                    $updateResult = DB::table($table_name)
                        ->where('app_id', '=', $app_id)
                        ->where('id', '=', $id)
                        ->update(['img_url_compressed' => $img_url_compressed]);
                    //删除本地文件
                    @unlink($src_image);
                    @unlink($tar_image);

                    Utils::logFrom($table_name." ".$app_id." ".$id." ".$updateResult, "ImageDealMiddleware.log");
                }
            }
        }
    }
}
