<?php

namespace App\Http\Controllers\Users;

use App\Http\Controllers\Tools\AppUtils;
use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\DB;

class OverviewController extends Controller
{
    //
    protected $app_id;
    public function __construct(){
        $this->app_id = AppUtils::getAppID();
    }

    public function index(){
        $date = date('Y-m-d');
        $openid=AppUtils::getOpenId();

        // 日新增用户   日活跃用户  日总收入
        $data = DB::connection('mysql_stat')->table('t_dash_stat_daycount')
            ->select('add_count','active_count','income')
            ->where('app_id',$this->app_id)
            ->where('date',$date)
            ->first();

        if (!$data){
            $data = new \stdClass();
            $data->add_count = 0;
            $data->active_count = 0;
            $data->sum_income = 0;
            $data->income = 0;
        }
        $data->sum_income = $data->income;
        // 可提现余额
        $count_balance = DB::connection("db_ex_finance")->table('t_usable_balance')
            ->where('app_id', $this->app_id)
            ->value('account_balance');
        $data->account_balance = $count_balance ? $count_balance : 0;

        // 流量账户余额
        $app_id = AppUtils::getAppID();
        $balance = DB::connection('mysql_config')->table('t_app_conf')
            ->where('app_id','=',$app_id)
            ->where('wx_app_type','=',1)
            ->value('balance');
        $data->balance = $balance ? $balance : 0;

        // 本月消费
        $month = date('Y-m');
        $pay = DB::connection('db_ex_finance')->table('t_balance_charge')
            ->select(DB::raw('sum(fee) as pay'))
            ->where('app_id',$this->app_id)
            ->where('charge_at','like',$month)
            ->whereIn('charge_type',[201,202,203,204,205])
            ->where('state',2)
            ->value('pay');
        $data->pay = $pay ? $pay : 0;
//        dump($data);
//        exit;

        //用户的商户名
        $name=DB::connection("mysql_config")->select("
            SELECT
                wx_app_name
            FROM
                t_merchant_conf
            WHERE
                merchant_id = (
                    SELECT
                        merchant_id
                    FROM
                        t_app_conf
                    WHERE
                        app_id = '{$this->app_id}'
                    AND wx_app_type = 1
                )    
	    ");
//         dump($name);
        if($name)   $data->name = $name[0]->wx_app_name ? $name[0]->wx_app_name : '小鹅通知识店铺';
        else    $data->name = '小鹅通知识店铺';

        $data->wx_app_id = AppUtils::getWxAppId();
        $data->is_collection = AppUtils::IsCollection();

        $message = DB::connection('mysql_config')->table('t_message_reminder')
            ->where('app_id',$this->app_id)
            ->where('place',0)
            ->first();
        $message_info = [] ;
        if (!$message){
            $message_info['app_id'] = $this->app_id;
            $message_info['content'] = "他们做得不错";
            $insert = DB::connection('mysql_config')->table('t_message_reminder')->insert($message_info);
            if ($insert) {
                $message = new \stdClass();
                $message->content = $message_info['content'];
                $message->status = 0;
            }
        }
        $data->message = $message;

        //优惠券上线提示
        $message_coupon=DB::connection('mysql_config')->table('t_message_reminder')
            ->where('app_id',$this->app_id)
            ->where('place',12)
            ->first();
        if(!$message_coupon)
        {
            $message_info['app_id']=$this->app_id;
            $message_info['content']="好消息！优惠券上线啦！";
            $message_info['place']=12;
            $message_info['status']=0;
            $insert = DB::connection('mysql_config')->table('t_message_reminder')->insert($message_info);
            if($insert) {
                $message_coupon =new \stdClass();
                $message_coupon->app_id=$this->app_id;
                $message_coupon->content= $message_info['content'];
                $message_coupon->place= $message_info['place'];
                $message_coupon->status=$message_info['status'];
            }
        }
        $data->message_coupon = $message_coupon;
//        echo '<pre>';
//        var_dump($message_res);
//            exit;
        return view('admin.guide.index',[
            'data' => $data
        ]);
    }

    public function closeMessageReminder(Request $request){
        $status = $request->input('status',0);
        $place=$request->input('place',0);
        if ($status){
            $update = DB::connection('mysql_config')->table('t_message_reminder')
                ->where('app_id',$this->app_id)
                ->where('place',$place)
                ->update(['status'=>1]);
            if ($update){
                return json_encode(['code'  => 0, 'msg'   => '请求成功', 'data'  =>[]]);
            }else {
                return json_encode(['code'  => -1, 'msg'   => '请求失败', 'data'  =>[]]);
            }
        }else {
            return json_encode(['code'  => -2, 'msg'   => '参数有误', 'data'  =>[]]);
        }
    }





}
