<?php

namespace App\Http\Middleware;

use App\Http\Controllers\Tools\AppUtils;
use App\Http\Controllers\Tools\Utils;
use Closure;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;

/**
 * 图片压缩中间件
 * Class ImageDealMiddleware
 * @package App\Http\Middleware
 */
class ImageDealMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle($request, Closure $next)
    {
        return $next($request);
    }

    /**
     * request->image_list 图片列表
     * @param $request
     * @param $response
     */
    public function terminate($request, $response){
        //Utils::logFrom(" aaa", "ImageDealMiddleware.log");
        $img_list = $request->image_list;

        if (!empty($img_list) && is_array($img_list) && count($img_list) > 0) {
            foreach ($img_list as $item) {
                $imageObj = $item;

                if (!empty($imageObj) && is_object($imageObj)) {
                    $table_name = $imageObj->table_name;
                    $app_id = $imageObj->app_id;
                    $id = $imageObj->id;
                    $image_url = $imageObj->image_url;
                    $compress_field = $imageObj->compress_field;
                    $image_width = $imageObj->image_width;
                    $image_height = $imageObj->image_height;
                    $image_quality = $imageObj->image_quality;
                    $query_id = $imageObj->query_id;
                    //Utils::logFrom($compress_field, "ImageDealMiddleware.log");
                    //**********************************


//                    Utils::logFrom("1", "ImageDealMiddleware.log");
//                  图片相同则不压缩
//                    $selectResult = DB::select("
//select * from $table_name where app_id = ? and $query_id = ? limit 1
//", [$app_id, $id]);
//                    Utils::logFrom("1".$selectResult, "ImageDealMiddleware.log");
//
//                    //*************************************
//                    if($selectResult->substr($compress_field,0,-11)==$image_url){
//                        Utils::logFrom("1".$selectResult.substr($compress_field,0,-11), "ImageDealMiddleware.log");
//                        return 0;
//                    }
//                    //下载原图//不用下载
//                    $src_image = Utils::downloadFileFromNet($image_url);
                    //压缩处理
                    $tar_image = Utils::imageCompress($image_url, $image_width, $image_height, $image_quality);
//                    Utils::logFrom("1".$tar_image, "ImageDealMiddleware.log");
                    //上传压缩图
                    $img_url_compressed = Utils::uploadCompressImage($tar_image, $app_id);
//                    Utils::logFrom("2".$img_url_compressed, "ImageDealMiddleware.log");
                    //更新数据库
                    if (empty($query_id)) {
                        $query_id = 'id';
                    }
//                    Utils::logFrom("3".$query_id, "ImageDealMiddleware.log");
//                    Utils::logFrom("3".$id." ". $app_id." ".$table_name, "ImageDealMiddleware.log");

                    $updateResult = DB::table($table_name)
                        ->where('app_id', '=', $app_id)
                        ->where($query_id, '=', $id)
                        ->update([$compress_field => $img_url_compressed]);
                    //删除本地文件
//                    @unlink($src_image);
//                    Utils::logFrom("4", "ImageDealMiddleware.log");
                    @unlink($tar_image);
                    //Utils::logFrom("5", "ImageDealMiddleware.log");
                    Utils::logFrom($table_name." ".$app_id." ".$id." ".$updateResult, "ImageDealMiddleware.log");
                }
            }
        }
    }
}
