<?php

namespace App\Http\Middleware;

use App\Http\Controllers\Tools\AppUtils;
use App\Http\Controllers\Tools\LogUtils;
use App\Http\Controllers\Tools\Utils;
use Closure;
use Illuminate\Support\Facades\DB;
use Route;
use Session;

use App\Http\Requests;

class AdminMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request $request
     * @param  \Closure $next
     * @return mixed
     */
    public function handle($request, Closure $next)
    {

//        // 记录访问日志
        $open_id = AppUtils::getOpenId();
        Utils::logFrom("openid:$open_id",'login.log');
        if (empty($open_id)) {
            AppUtils::clearLoginStatus();
            return redirect()->guest('/login');
        } else {
            $loginResult = DB::select("select login_id from db_ex_config.t_mgr_login where openid = '$open_id'");
            if (empty($loginResult) || count($loginResult) == 0) {
                AppUtils::clearLoginStatus();
                return redirect()->guest('/login');
            }
        }

        LogUtils::insertOperateLog($request);

        $access = Session::get('access',[]);
        // 没有拿到权限，跳转login
        if (!$access || count($access) < 10) return redirect('/login');

        $name = Route::currentRouteName();
        if ($name){
            $permission = explode('.',$name);
        }else {
            $permission = [];
        }

        if ($permission && count($permission) > 0){
            $key = $permission[0];
            if ($key && $access[$key] < 1) return redirect()->back()->with('accessError','您的账号没有相关操作权限，如有疑问请联系店铺管理员');

            if (count($permission) > 1){
                if ($permission[1]) $key = $permission[1];
//                if ($key && $access[$key] < 1) return redirect();
                if ($key && $access[$key] < 1) return redirect()->back()->with('accessError','您的账号没有相关操作权限，如有疑问请联系店铺管理员');
            }

        }

        return $next($request);
    }
}
