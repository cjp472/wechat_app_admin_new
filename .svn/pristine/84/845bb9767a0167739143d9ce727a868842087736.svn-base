/**
 * Created by Administrator on 2017/7/31.
 */

$(document).ready(function () {
    $exeBookList.init();
});

$exeBookList = (function () {
    var $exeBookList = {
        addUserType: 1, //1-老师；0-助教

    };
    var $private = {
        userListPageIndex: 1,
        userListSearchContent: "",
        isSearchUserWindowLoading: false,
        isSearchUserWindowToBottom: false,
    };

    $exeBookList.init = function () {

        //作业本的操作
        $(".operateList > li.operate").click(function () {
            var $self = $(this),
                $parent = $self.parents(".exerciseBookOperateArea"),
                type = $self.data("type"),
                resId = $parent.data("resource_id"),
                exerciseBookId = $parent.data("exercise_book_id");

            switch (type) {
                case "role_manage":
                    baseUtils.showWindow("roleManageWindow");
                    break;
                case "exercise_list":
                    window.location.href = "/exercise/exercise_list";
                    break;
                case "edit_exercise_book":
                    window.location.href = "/exercise/edit_exercise_book?exercise_book_id="+exerciseBookId;
                    break;
                default:
                    console.log("参数错误");
                    break;
            }

        });

        /*********************** 人员设置窗口 *************************/
        $("#windowCloseIcon1").click(function () {
            baseUtils.hideWindow("roleManageWindow");
        });

        $("#windowHoverBox").on("click", "li", function () {
            var type = $(this).data("type");
            if (type == "add_teacher") {
                $exeBookList.addUserType = 1;
            } else if (type == "add_assistant") {
                $exeBookList.addUserType = 0;
            }
            openSearchUserWindow();

        });

        /*********************** 人员搜索窗口 *************************/

        $("#windowCloseIcon2").click(function () {
            baseUtils.hideWindow("searchUserWindow");
            baseUtils.showWindow("roleManageWindow");
        });
        //点击搜索
        $("#searchUserWindow").on("click", "#windowSearchBtn", function () {
            $private.userListPageIndex = 1;
            $private.userListSearchContent = $.trim($("#windowSearchInput").val());
            $private.isSearchUserWindowToBottom = false;
            $('#searchUserWindow .windowContentWrapper2').scrollTop(0);
            getAllUserList();
        });
        $("#windowSearchInput").on("keypress", function (e) {
            if (e.keyCode == 13) {
                $("#windowSearchBtn").click();
            }
        });
        //滑动加载更多
        $('#searchUserWindow .windowContentWrapper2').scroll(function(e) {
            var DivHeight = $('#windowContent2').height(),
                ScrollHeight = $(this).height(),
                ScrollTop = $(this).scrollTop();
            if ((ScrollTop + ScrollHeight >= DivHeight - 5) && !$private.isSearchUserWindowLoading
                && !$private.isSearchUserWindowToBottom) {
                getAllUserList();
            }
        });


    };
    function openSearchUserWindow() {
        baseUtils.hideWindow("roleManageWindow");
        
        $("#searchUserWindow").find(".headerText1").text(
            ($exeBookList.addUserType==1)?"添加老师":"添加助教"
        );
        baseUtils.showWindow("searchUserWindow");
        
        $private.isSearchUserWindowToBottom = false;
        $private.userListPageIndex = 1;
        $private.userListSearchContent = "";
        getAllUserList();
    }
    function getAllUserList() {
        baseUtils.showLoading("searchUserLoading");
        $private.isSearchUserWindowLoading = true;
        $.ajax("/zbsearch", {
            type: "GET",
            dataType: "json",
            data: {
                page: $private.userListPageIndex,
                search: $private.userListSearchContent
            },
            success: function (result) {
                baseUtils.hideLoading("searchUserLoading");
                $private.isSearchUserWindowLoading = false;

                var $area = $("#windowContent2"),
                    htmlStr = "",
                    offset = result.page_offset;

                $.each(result.data, function (k, v) {
                    htmlStr +=
                        '<div class="singleGuestInfo2" data-user_id="'+v.user_id+
                                '" data-wx_avatar="'+v.wx_avatar+'" data-wx_nickname="'+v.wx_nickname+'">'+
                            '<input type="checkbox" '+(v.state==0?'checked disabled':'')+' class="selectSingleGuest '+(v.state==0?'disabled':'')+'" id="'+v.user_id+'">'+
                            '<label for="'+v.user_id+'" class="singleGuestLabel">'+
                                '<img src="'+v.wx_avatar+'" class="singleGuestAvatar2">'+
                                '<div class="singleGuestName2" title="'+v.wx_nickname+'">'+v.wx_nickname+'</div>'+
                            '</label>'+
                        '</div>';
                });
                if (htmlStr.length == 0) {
                    htmlStr =
                        '<div class="windowNoData" id="windowNoData">暂无数据</div>';
                }
                if ($private.userListPageIndex == 1) {
                    $area.html(htmlStr);
                    $area.append('<div class="isDown">更多数据加载中</div>');
                } else {
                    $area.find('.isDown').before(htmlStr);
                }
                if (offset.current_page >= offset.total_pages) {      //数据加载完毕后的操作
                    if (offset.total_count > 10) {
                        $area.find('.isDown').text("数据已加载完毕");
                    } else {
                        $area.find('.isDown').hide();
                    }
                    $private.isSearchUserWindowToBottom = true;
                }
                $private.userListPageIndex ++;

            },
            error: function (xhr, status, err) {
                baseUtils.hideLoading("searchUserLoading");
                $private.isSearchUserWindowLoading = false;
                console.log(err);
                alert("服务器出小差了，请稍后再试！");
            }
        });
    };

    return $exeBookList;
})();



























