<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/7/31
 * Time: 11:35
 */

namespace App\Http\Controllers\Community;

use App\Http\Controllers\Controller;
use App\Http\Controllers\Tools\AppUtils;
use App\Http\Controllers\Tools\StringConstants;
use App\Http\Controllers\Tools\Utils;
use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\Input;
use Mockery\Matcher\Ducktype;

class ExerciseController extends Controller {

    public function exerciseBookList() {

        $data = "exerciseBookList";
        $search_content = Input::get("search_content", "");

        return View("admin.exercise.exerciseBookList", compact("data", "search_content"));

    }

    public function createExerciseBook() {

        $data = "createExerciseBook";
        $page_type = 0;

        return View("admin.exercise.manageExerciseBook", compact("data", "page_type"));

    }

    public function editExerciseBook() {

        $data = "editExerciseBook";
        $page_type = 1;

        return View("admin.exercise.manageExerciseBook", compact("data", "page_type"));

    }

    /**
     * 函数名:uploadExerciseBook
     * 参数:
     *      1-title（作业本名称）
     *      2-resource_id（关联的课程id）
     *      3-resource_type(资源类型；1-图文；2-音频；3-视频；4-直播；5-专栏)
     *      4-resource_name（关联的课程名称）
     *      5-community_id（关联的社群id）
     *      6-is_enable_notify（是否允许老师推送作业提醒开关，0-不允许；1-允许）
     * 作用:创建作业本
     * 作者:keven
     * 时间:2017-07-31 19:45:27
     * 返回值:jason格式（【code   data   msg】）
     */
    public function uploadExerciseBook(){
        $params = Input::get('params');
        $operator_type = StringConstants::EXERCISE_BOOK_ADD;
        $ret = $this->saveExerciseBook($params,$operator_type);

        if($ret == '0'){
            Utils::logFrom("upload resource record successed!",'fhw_exercise.log');
            return Utils::result('新增作业本成功!');
        }else{
            $msg = $ret;
            return response()->json(Utils::pack("0", StringConstants::Code_Failed, $msg));
        }

    }

    /**
     * 函数名:updateExerciseBook
     * 参数:
     *      1-title（作业本名称）
     *      2-resource_id（关联的课程id）
     *      3-resource_type(资源类型；1-图文；2-音频；3-视频；4-直播；5-专栏)
     *      4-resource_name（关联的课程名称）
     *      5-community_id（关联的社群id）
     *      6-is_enable_notify（是否允许老师推送作业提醒开关，0-不允许；1-允许）
     * 作用:更新作业本
     * 作者:keven
     * 时间:2017-07-31 20:10:55
     * 返回值:jason格式（【code   data   msg】）
     */
    public function updateExerciseBook(){
        $params = Input::get('params');
        if(!array_key_exists('exercise_book_id',$params)){
            return response()->json(Utils::pack("0", StringConstants::Code_Failed, '缺少参数:作业本id'));
        }
        $exercise_book_id = $params['exercise_book_id'];
        $app_id = AppUtils::getAppID();
        //查询该作业本的信息
        $exercise_book_info = $this->getExerciseBookInfo($app_id,$exercise_book_id);
        if($exercise_book_info){
            if(!array_key_exists('resource_id',$params)){
                return response()->json(Utils::pack("0", StringConstants::Code_Failed, '缺少参数:关联的课程'));
            }
            if($exercise_book_info->resource_id!=$params['resource_id']){
                //校验该作业本是否已经有人创建了作业,若有则不能变更关联的课程
                $is_has_exercise = $this->isHasExercise($app_id,$exercise_book_id);
                if($is_has_exercise != 0){//有人创建了作业
                    return response()->json(Utils::pack("0", StringConstants::Code_Failed, '作业本已存在作业,不能更改关联的课程'));
                }

            }
        }else{
            return response()->json(Utils::pack("0", StringConstants::Code_Failed, '该作业本不存在'));
        }
        $operator_type = StringConstants::EXERCISE_BOOK_EDIT;
        $ret = $this->saveExerciseBook($params,$operator_type);

        if($ret == '0'){
            Utils::logFrom("update resource record successed!",'fhw_exercise.log');
            return Utils::result('更新作业本成功!');
        }else{
            $msg = $ret;
            return response()->json(Utils::pack("0", StringConstants::Code_Failed, $msg));
        }
    }

    //保存作业本信息
    private function saveExerciseBook($params,$operator_type){
        //参数校验
        if(!array_key_exists('title',$params) || Utils::isEmptyString($params['title'])){
            return '作业本名称不能为空';
        }
        if(!array_key_exists('resource_id',$params) || Utils::isEmptyString($params['resource_id'])){
            return '关联的课程不能为空';
        }
        if(!array_key_exists('resource_type',$params) || Utils::isEmptyString($params['resource_type'])){
            return '关联的课程类型不能为空';
        }
        if(!array_key_exists('resource_name',$params) || Utils::isEmptyString($params['resource_name'])){
            return '关联的课程不能为空';
        }

        if($operator_type == StringConstants::EXERCISE_BOOK_ADD){//新增作业本
            $params['created_at'] = Utils::getTime();
            $params['app_id'] = AppUtils::getAppID();
            $params['exercise_book_id'] = Utils::getUniId('e_');
            $ret = \DB::table('db_ex_business.t_exercise_books')->insert($params);
            $msg = '新增作业本成功';
        }else{//更新作业本
            $params['updated_at'] = Utils::getTime();
            $ret = \DB::table('db_ex_business.t_exercise_books')
                ->where('app_id','=',AppUtils::getAppID())
                ->where('exercise_book_id','=',$params['exercise_book_id'])
                ->update($params);
            $msg = "更新作业本失败";
        }

        if($ret){
            return StringConstants::Code_Succeed;
        }else{
            return $msg;
        }

    }

    //校验该作业本是否已经有人创建了作业,若有则不能变更关联的课程
    private function isHasExercise($app_id,$exercise_book_id){
        //在表db_ex_business.t_exercises中查询该作业本下是否有有效的作业记录
        $exercises_count = \DB::table('db_ex_business.t_exercises')
            ->where('app_id','=',$app_id)
            ->where('exercise_book_id','=',$exercise_book_id)
            ->count();
        return $exercises_count;
    }

    //查询作业本的信息
    private function getExerciseBookInfo($app_id,$exercise_book_id){
        //在表db_ex_business.t_exercise_books中查询该作业本信息
        $exercise_info = \DB::table('db_ex_business.t_exercise_books')
            ->where('app_id','=',$app_id)
            ->where('exercise_book_id','=',$exercise_book_id)
            ->first();
        return $exercise_info;
    }
}



















