<?php

namespace App\Http\Controllers\Marketing;

use App\Http\Controllers\Tools\AppUtils;
use App\Http\Controllers\Tools\Utils;
use Illuminate\Pagination\Paginator;
use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Support\Facades\DB;

class InviteController extends Controller
{
    protected $app_id;
    public function __construct()
    {
        $this->app_id = AppUtils::getAppID();
    }

    //index
    public function index(Request $request){
        $name = $request->input('name','');

        $sql = "
        SELECT id, img_url_compressed, name, price, created_at, goods_type, ifnull(sum, 0) as sum, invite_poster,distribute_percent,is_show_userinfo,is_member
        FROM (
            SELECT t1.id , t1.img_url_compressed, t1.name, t1.price, t1.created_at, t1.goods_type, t2.sum, t1.invite_poster,t1.is_show_userinfo,t1.distribute_percent,t1.is_member
            FROM (
                SELECT app_id, id, img_url_compressed, name, price, created_at, 0 as goods_type, invite_poster,is_show_userinfo,distribute_percent,is_member
                FROM t_pay_products
                WHERE app_id = '{$this->app_id}' AND state IN (0, 1) AND name like '%{$name}%'
            ) t1 LEFT JOIN (
                SELECT app_id, order_id, payment_type, product_id, sum(count) AS sum 
                FROM t_orders
                WHERE app_id = '{$this->app_id}' AND order_state = 1
                GROUP BY product_id
            ) t2 on t1.app_id = t2.app_id AND t1.id = t2.product_id
            
            UNION ALL
            
            SELECT t1.id , t1.img_url_compressed, t1.title as name, t1.piece_price as price, t1.created_at, t1.goods_type, t2.sum, t1.invite_poster,t1.is_show_userinfo,t1.distribute_percent, t1.is_member
            FROM (
                SELECT app_id, id, img_url_compressed, title, piece_price, created_at, 2 as goods_type, invite_poster,is_show_userinfo,distribute_percent, -1 as is_member
                FROM t_audio
                WHERE app_id = '{$this->app_id}' AND audio_state IN (0, 1) and payment_type = 2 AND title like '%{$name}%'
            ) t1 LEFT JOIN (
                SELECT app_id, resource_id, sum(count) AS sum 
                FROM t_orders
                WHERE app_id = '{$this->app_id}' AND order_state = 1 and resource_type = 2
                GROUP BY resource_id
            ) t2 on t1.app_id = t2.app_id and t1.id = t2.resource_id
            
            UNION ALL
            
            SELECT t1.id , t1.img_url_compressed, t1.title as name, t1.piece_price as price, t1.created_at, t1.goods_type, t2.sum,t1.invite_poster, t1.is_show_userinfo ,t1.distribute_percent,t1.is_member
            FROM (
              SELECT app_id, id, img_url_compressed, title, piece_price, created_at, 3 as goods_type,invite_poster, is_show_userinfo,distribute_percent, -1 as is_member
              FROM t_video
              WHERE app_id = '{$this->app_id}' AND video_state IN (0, 1) and payment_type = 2 AND title like '%{$name}%'
            ) t1 LEFT JOIN (
              SELECT app_id, resource_id, sum(count) AS sum 
              FROM t_orders
              WHERE app_id = '{$this->app_id}' AND order_state = 1 and resource_type = 3
              GROUP BY resource_id
            ) t2 on t1.app_id = t2.app_id and t1.id = t2.resource_id
            
            UNION ALL
            
            SELECT t1.id , t1.img_url_compressed, t1.title as name, t1.piece_price as price, t1.created_at, t1.goods_type, t2.sum, t1.invite_poster,t1.is_show_userinfo,t1.distribute_percent,t1.is_member
            FROM (
              SELECT app_id, id, img_url_compressed, title, piece_price, created_at, 1 as goods_type,invite_poster,is_show_userinfo, distribute_percent, -1 as is_member
              FROM t_image_text
              WHERE app_id = '{$this->app_id}' AND display_state IN (0, 1) and payment_type = 2 AND title like '%{$name}%'
            ) t1 LEFT JOIN (
              SELECT app_id, resource_id, sum(count) AS sum FROM t_orders
              WHERE app_id = '{$this->app_id}' AND order_state = 1 and resource_type = 1
              GROUP BY resource_id
            ) t2 on t1.app_id = t2.app_id and t1.id = t2.resource_id
            
            UNION ALL
            
            SELECT t1.id , t1.img_url_compressed, t1.title as name, t1.piece_price as price, t1.created_at, t1.goods_type, t2.sum,t1.invite_poster,t1.is_show_userinfo, t1.distribute_percent,t1.is_member
            FROM (
              SELECT app_id, id, img_url_compressed, title, piece_price, created_at, 4 as goods_type, invite_poster,is_show_userinfo,distribute_percent, -1 as is_member
              FROM t_alive
              WHERE app_id = '{$this->app_id}' AND state IN (0, 1) and payment_type = 2 AND title like '%{$name}%'
            ) t1 LEFT JOIN (
              SELECT app_id, resource_id, sum(count) AS sum
              FROM t_orders
              WHERE app_id = '{$this->app_id}' AND order_state = 1 AND resource_type = 4
              GROUP BY resource_id
            ) t2 on t1.app_id = t2.app_id and t1.id = t2.resource_id
        ) tt1 order by created_at desc";

        $ListInfo = DB::connection('mysql')->select($sql);



        if ($ListInfo){
            // 手动分页
            $page = $request->input('page','');
            $total = count($ListInfo);
            $perPage = 10;
            // 判断当前页数
            if ($page) {
                $current_page = $page;
                $current_page = $current_page <= 0 ? 1 :$current_page;
            } else {
                $current_page = 1;
            }
            //手动切割结果集
            $item = array_slice($ListInfo, ($current_page-1)*$perPage, $perPage);
//        echo '<pre>';
            $paginator =new LengthAwarePaginator($item, $total, $perPage, $current_page, [
                'path' => Paginator::resolveCurrentPath(), //生成路径
                'pageName' => 'page',
            ]);

            foreach ($paginator as $v){
                if ($v->distribute_percent == 0){
                    $v->is_invite = 0;
                    $v->distribute_percent = '';
                    $v->distribute_price = '';
                }else {
                    $v->is_invite = 1;
                    $v->distribute_price = $v->price * $v->distribute_percent * 0.01;
                    $v->distribute_price = floor($v->distribute_price);
                }

                if ($v->is_member == 1){
                    $v->goods_type = 5;
                }
            }
        }else {
            $paginator = [];
        }

//        dump($paginator);
        return view('admin.marketing.invitation',[
            'paginator' => $paginator,
            'name' => $name
        ]);
    }

    // 邀请卡设置
    public function set(Request $request){
        $id = $request->input('id','');
        $goods_type = $request->input('goods_type','');
        $distribute_percent = $request->input('distribute_percent','');
        $invite_poster = $request->input('invite_poster','');
//        是否显示用户信息
        $is_show_userinfo = $request->input('is_show_userinfo',0);

        if ($id && ($goods_type >= 0)){
            // 查询该商品信息是否存在
//            dd($goods_type);
            switch ($goods_type){
                case 0:
                    $table_name = "t_pay_products";
                    break;
                case 1:
                    $table_name = "t_image_text";
                    break;
                case 2:
                    $table_name = "t_audio";
                    break;
                case 3:
                    $table_name = "t_video";
                    break;
                case 4:
                    $table_name = "t_alive";
                    break;
                case 5:
                    $table_name = "t_pay_products";
                    break;
                default:
                    $table_name = "";
            }

//            dd($table_name);
            if ($table_name){

                $exist = DB::connection('mysql')->table($table_name)
                    ->where('app_id',$this->app_id)
                    ->where('id',$id)
                    ->get();

                if ($exist){
                    if ($distribute_percent >= 0 ){
                        $update = DB::connection('mysql')->table($table_name)
                            ->where('app_id',$this->app_id)
                            ->where('id',$id)
                            ->update([
                                'distribute_percent'=>$distribute_percent,
                                'invite_poster' => $invite_poster,
                                'is_show_userinfo' =>  $is_show_userinfo,
                                'updated_at' => date('Y-m-d H:i:s',time())
                            ]);

                        if ($update){
                            return response()->json(['code'=>0,'msg'=>'更新成功']);
                        }else{
                            return response()->json(['code'=>-2,'msg'=>'更新失败']);
                        }

                    }else {
                        return response()->json(['code'=>-1,'msg'=>'参数有误']);
                    }
                } else {
                    return response()->json(['code'=>-1,'msg'=>'商品信息不存在']);
                }
            }else {
                return response()->json(['code'=>-1,'msg'=>'商品类型不存在']);
            }
        }else {
            return response()->json(['code'=>-1,'msg'=>'参数有误']);
        }

    }



}
