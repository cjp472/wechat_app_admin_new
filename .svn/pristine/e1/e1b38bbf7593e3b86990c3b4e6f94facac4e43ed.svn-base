<?php

namespace App\Http\Controllers\Users;

use App\Http\Controllers\Tools\AppUtils;
use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use DB;
use Session;

class OverviewController extends Controller
{
    //
    protected $app_id;
    public function __construct(){
        $this->app_id = AppUtils::getAppID();
    }

    public function index(){
        $date = date('Y-m-d');
        $openid=AppUtils::getOpenId();

        //总用户数 日新增用户  日新增付费用户  日活跃用户  日总收入  总收入
        $data = DB::connection('mysql_stat')->table('t_dash_stat_daycount')
            ->select('sum_count','add_count','pay_count','active_count','sum_income','income')
            ->where('app_id',$this->app_id)
            ->where('date',$date)
            ->first();

        if (!$data){
            $data = new \stdClass();
            $data->sum_count = 0;
            $data->add_count = 0;
            $data->pay_count = 0;
            $data->active_count = 0;
            $data->sum_income = 0;
            $data->income = 0;
        }
//        $data->sum_income = $data->income;
        // 可提现余额
        $count_balance = DB::connection("db_ex_finance")->table('t_usable_balance')
            ->where('app_id', $this->app_id)
            ->value('account_balance');
        $data->account_balance = $count_balance ? $count_balance : 0;

        // 流量账户余额
        $app_id = AppUtils::getAppID();
        $balance = DB::connection('mysql_config')->table('t_app_conf')
            ->where('app_id','=',$app_id)
            ->where('wx_app_type','=',1)
            ->value('balance');
        $data->balance = $balance ? $balance : 0;


        // 本月消费
//        $month = date('Y-m');
//        $pay = DB::connection('db_ex_finance')->table('t_balance_charge')
//            ->select(DB::raw('sum(fee) as pay'))
//            ->where('app_id',$this->app_id)
//            ->where('charge_at','like',$month)
//            ->whereIn('charge_type',[201,202,203,204,205])
//            ->where('state',2)
//            ->value('pay');
//        $data->pay = $pay ? $pay : 0;

        //用户的商户名
        $name=DB::connection("mysql_config")->select("
            SELECT
                wx_app_name
            FROM
                t_merchant_conf
            WHERE
                merchant_id = (
                    SELECT
                        merchant_id
                    FROM
                        t_app_conf
                    WHERE
                        app_id = '{$this->app_id}'
                    AND wx_app_type = 1
                )    
	    ");
        if($name)   $data->name = $name[0]->wx_app_name ? $name[0]->wx_app_name : '小鹅通知识店铺';
        else    $data->name = '小鹅通知识店铺';

//
        $res_arr = [];

        $member = \DB::table('t_pay_products')
            ->select('id','name as title')
            ->where('app_id','=',$this->app_id)
            ->where('is_member','=',1)
            ->where('state','=',0)
            ->orderBy('created_at','desc')
            ->get();
        $res_arr['member']['count'] = count($member);
        if($res_arr['member']['count'] > 3)
            $res_arr['member']['data'] = array_only($member, [0,1,2]);
        else
            $res_arr['member']['data'] = $member;

        $column = \DB::table('t_pay_products')
            ->select('id','name as title')
            ->where('app_id','=',$this->app_id)
            ->where('is_member','=',0)
            ->where('state','=',0)
            ->orderBy('created_at','desc')
            ->get();
        $res_arr['column']['count'] = count($column);
        if($res_arr['column']['count'] > 3)
            $res_arr['column']['data'] = array_only($column, [0,1,2]);
        else
            $res_arr['column']['data'] = $column;

        $table_arr = ['t_alive','t_audio','t_video','t_image_text','t_community','t_activity'];
        foreach ($table_arr as $k => $v){
            switch ($k){
                case 0:$state = 'state';break;
                case 1:$state = 'audio_state';break;
                case 2:$state = 'video_state';break;
                case 3:$state = 'display_state';break;
                case 4:$state = 'community_state';break;
                case 5:$state = 'activity_state';break;
            }
            $temp = \DB::table($v)
                ->select('id','title')
                ->where('app_id','=',$this->app_id)
                ->where($state,'=',0)
                ->orderBy('created_at','desc')
                ->get();
            $key = substr($v,2);
            $res_arr[$key]['count'] = count($temp);
            if($res_arr[$key]['count'] > 3)
                $res_arr[$key]['data'] = array_only($temp, [0,1,2]);
            else
                $res_arr[$key]['data'] = $temp;
        }

        $que_title = DB::table('t_que_products')
            ->select('id','title')
            ->where('app_id','=',$this->app_id)
//            ->where('state','=',0)
            ->get();
        if($que_title){
            $res_arr['question']['count'] = 1;
            $res_arr['question']['data']  = $que_title;
        } else {
            $res_arr['question']['count'] = 0;
            $res_arr['question']['data']  = [];
        }

//        return $res_arr;
//
//        var_dump($res_arr);
//        exit;

        $data->wx_app_id = AppUtils::getWxAppId();
        $data->is_collection = AppUtils::IsCollection();
//
        $message = DB::connection('mysql_config')->table('t_message_reminder')
            ->where('app_id',$this->app_id)
            ->where('place',0)
            ->first();
        $message_info = [] ;
        if (!$message){
            $message_info['app_id'] = $this->app_id;
            $message_info['content'] = "他们做得不错";
            $insert = DB::connection('mysql_config')->table('t_message_reminder')->insert($message_info);
            if ($insert) {
                $message = new \stdClass();
                $message->content = $message_info['content'];
                $message->status = 0;
            }
        }
        $data->message = $message;
//
        //优惠券上线提示
        $message_coupon=DB::connection('mysql_config')->table('t_message_reminder')
            ->where('app_id',$this->app_id)
            ->where('place',12)
            ->first();
        if(!$message_coupon)
        {
            $message_info['app_id']=$this->app_id;
            $message_info['content']="好消息！优惠券上线啦！";
            $message_info['place']=12;
            $message_info['status']=0;
            $insert = DB::connection('mysql_config')->table('t_message_reminder')->insert($message_info);
            if($insert) {
                $message_coupon =new \stdClass();
                $message_coupon->app_id=$this->app_id;
                $message_coupon->content= $message_info['content'];
                $message_coupon->place= $message_info['place'];
                $message_coupon->status=$message_info['status'];
            }
        }
        $data->message_coupon = $message_coupon;


        return view('admin.guide.index',[
            'data' => $data,
            'res_arr' => $res_arr
        ]);
    }

    public function closeMessageReminder(Request $request){
        $status = $request->input('status',0);
        $place=$request->input('place',0);
        if ($status){
            $update = DB::connection('mysql_config')->table('t_message_reminder')
                ->where('app_id',$this->app_id)
                ->where('place',$place)
                ->update(['status'=>1]);
            if ($update){
                return json_encode(['code'  => 0, 'msg'   => '请求成功', 'data'  =>[]]);
            }else {
                return json_encode(['code'  => -1, 'msg'   => '请求失败', 'data'  =>[]]);
            }
        }else {
            return json_encode(['code'  => -2, 'msg'   => '参数有误', 'data'  =>[]]);
        }
    }


    public function redirectCurrentUrl($id){
        // 声明一级不需要跳转子权限页的父类权限
        $parent_id = [101,102,103,105];

        // 可跳转链接
        $permission = [
            101=>'/package_list_page?prompt=1',
            102=>'/marketing',
            103=>'/community_operate',
            105=>'/dashboard',
            108=>'/interfacesetting',
            109=>'/shopIndexDiy',
            110=>'/sharesetting',
            111=>'/wxaccountsetting',
            112=>'/manage_function',
            122=>'/customer',
            123=>'/pay_admin',
            124=>'/message',
            125=>'/feedback',
            126=>'/income/company',
            127=>'/income/person',
            128=>'/order_list',
            129=>'/withdraw_page',
            130=>'/accountview',
            999=>'/accountmanage',
            131=>'/admin/child',
            132=>'/companymodel',
            133=>'/mini/index'
        ];


        if (!$id) return response()->json(['code'=>-1,'msg'=>'参数错误','data'=>[]]);

        // 没有权限就跳转登陆
        $access = Session::get('access',[]);
        if (!$access) return redirect('/login');

        if (!array_key_exists($id,$access) || $id > 107) return response()->json(['code'=>-1,'msg'=>'参数错误','data'=>[]]);

        if ($access[$id] < 0) return response()->json(['code'=>-2,'msg'=>'无访问权限','data'=>[]]);

        // 直接跳转至对应路由
        if ($access[$id]) {
            if (in_array($id,$parent_id)) return redirect($permission[$id]);

            //获取可用的子权限
            $privilege = DB::connection('mysql_config')->table('t_admin_privilege')->whereNull('deleted_at')->where('parent_id',$id)->pluck('id');

            foreach ($privilege as $v){
                if ($access[$v]) return redirect($permission[$v]);
            }
        }
    }


}
