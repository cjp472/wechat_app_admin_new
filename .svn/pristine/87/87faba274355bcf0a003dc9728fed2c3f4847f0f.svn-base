/**
 * Created by Administrator on 2017/7/31.
 */

$(document).ready(function () {
    $exeBookList.init();
});

$exeBookList = (function () {
    var $exeBookList = {
        addUserType: 0, //0-老师；1-助教
        exerciseBookId: -1, //点击的作业本条目的id值
    };
    var $private = {
        userListPageIndex: 1,
        userListSearchContent: "",
        isSearchUserWindowLoading: false,
        isSearchUserWindowToBottom: false,
    };

    $exeBookList.init = function () {

        //作业本的操作
        $(".operateList > li.operate").click(function () {
            var $self = $(this),
                $parent = $self.parents(".exerciseBookOperateArea"),
                type = $self.data("type"),
                resId = $parent.data("resource_id"),
                resType = $parent.data("resource_type"),
                exerciseBookId = $parent.data("exercise_book_id"),
                roleListArr = $parent.data("role_list");

            $exeBookList.exerciseBookId = exerciseBookId;

            switch (type) {
                case "role_manage":
                    openRoleManageWindow(resType, roleListArr);
                    break;
                case "exercise_list":
                    window.location.href = "/exercise/exercise_list?exercise_book_id="+exerciseBookId;
                    break;
                case "edit_exercise_book":
                    window.location.href = "/exercise/edit_exercise_book?exercise_book_id="+exerciseBookId;
                    break;
                default:
                    console.log("参数错误");
                    break;
            }

        });

        /*********************** 人员设置窗口 *************************/
        $("#windowCloseIcon1").click(function () {
            baseUtils.hideWindow("roleManageWindow");
        });
        //添加人员
        $("#windowHoverBox").on("click", "li", function () {
            var type = $(this).data("type");
            if (type == "add_teacher") {//需要加限制
                if (hasSetTeacher()) {
                    baseUtils.show.redTip("一个作业本仅能设置1位老师，请先将已设置的老师改为助教");
                    return false;
                }
                $exeBookList.addUserType = 0;
            } else if (type == "add_assistant") {
                $exeBookList.addUserType = 1;
            }
            openSearchUserWindow();
        });
        // radio 按钮点击切换效果
        $('#windowContent1').on('click', '.roleTypeRadio', function(e) {
            var $self = $(this),
                clickRoleType = $self.children(".circleRadio").data("role_type");

            if ($self.children(".circleRadio").hasClass("radioActive")) {
                return false;
            }
            if (clickRoleType == 0 && hasSetTeacher()) {   //设置为老师
                baseUtils.show.redTip("一个作业本仅能设置1位老师，请先将已设置的老师改为助教");
                return false;
            }
            $self.parents(".roleTypeRadioWrapper").find(".circleRadio").removeClass('radioActive');
            $self.children('.circleRadio').addClass('radioActive');
        });
        //移除用户
        $("#roleManageWindow").on("click", ".deleteSingleUser", function () {
            var $parent = $(this).parents(".singleUserInfo1");

            $parent.css({"height": "0", "padding": "0"});
            setTimeout(function () {
                $parent.remove();
                var count = $("#windowContent1").find(".singleUserInfo1").length;
                if (count == 0) {
                    $("#windowContent1").html(
                        '<div class="windowNoData" id="windowNoData1">暂无老师和助教，请点击下方按钮快速添加人员</div>'
                    );
                }
            }, 300);
        });
        //保存人员
        $("#confirmSaveRole").click(function () {
            var addedUserList = $("#windowContent1").find(".singleUserInfo1"),
                exerciseBookRoles = {};

            addedUserList.each(function () {
                var userId = $(this).data("user_id"),
                    roleType = $(this).find(".circleRadio.radioActive").data("role_type");
                if (exerciseBookRoles[userId] == undefined) {
                    exerciseBookRoles[userId] = {
                        user_id: userId,
                        role_type: roleType
                    }
                }
            });

            baseUtils.showLoading("roleManageLoading");
            $.ajax("/exercise/set_exercise_book_role", {
                type: "POST",
                dataType: "json",
                data: {
                    exercise_book_roles: exerciseBookRoles,
                    exercise_book_id: $exeBookList.exerciseBookId
                },
                success: function (result) {
                    baseUtils.hideLoading("roleManageLoading");
                    if (result.code == 0) {
                        baseUtils.hideWindow("roleManageWindow");
                        baseUtils.show.blueTip("保存成功");
                        setTimeout(function () {
                            window.location.reload();
                        }, 1000);
                    } else {
                        baseUtils.show.redTip("网络问题，请稍后再试");
                    }
                },
                error: function (xhr, status, err) {
                    baseUtils.hideLoading("roleManageLoading");
                    console.log(err);
                    alert("服务器出小差了，请稍后再试！");
                }
            });

        });

        /*********************** 人员搜索窗口 *************************/
        $("#windowCloseIcon2").click(function () {
            baseUtils.hideWindow("searchUserWindow");
            baseUtils.showWindow("roleManageWindow");
        });
        //点击搜索
        $("#searchUserWindow").on("click", "#windowSearchBtn", function () {
            $private.userListPageIndex = 1;
            $private.userListSearchContent = $.trim($("#windowSearchInput").val());
            $private.isSearchUserWindowToBottom = false;
            $('#searchUserWindow .windowContentWrapper2').scrollTop(0);
            getAllUserList();
        });
        $("#windowSearchInput").on("keypress", function (e) {
            if (e.keyCode == 13) {
                $("#windowSearchBtn").click();
            }
        });
        //滑动加载更多
        $('#searchUserWindow .windowContentWrapper2').scroll(function(e) {
            var DivHeight = $('#windowContent2').height(),
                ScrollHeight = $(this).height(),
                ScrollTop = $(this).scrollTop();
            if ((ScrollTop + ScrollHeight >= DivHeight - 5) && !$private.isSearchUserWindowLoading
                    && !$private.isSearchUserWindowToBottom) {
                getAllUserList();
            }
        });
        //添加老师时，添加限制，只能选中一个
        $("#windowContent2").on("change", ".selectSingleGuest", function (e) {
            var $target = $(e.target),
                isChecked = $target.prop("checked");
            if (isChecked && $exeBookList.addUserType == 0) {
                var count = $("#windowContent2").find(".selectSingleGuest:checked").length;
                if (count > 1) {
                    baseUtils.show.redTip("一个作业本仅能设置1位老师");
                    $target.prop("checked", false);
                }
            }
        });
        //添加人员
        $("#confirmSaveAddedUser").click(function () {
            var checkedUser = $(".selectSingleGuest:checked"),
                userArr = {};
            checkedUser.each(function () {
                var $parent = $(this).parents(".singleGuestInfo2"),
                    userId = $parent.data("user_id"),
                    wxAvatar = $parent.data("wx_avatar"),
                    wxNickname = $parent.data("wx_nickname"),
                    roleType = $exeBookList.addUserType;

                if (userArr[userId] == undefined) {
                    userArr[userId] = {
                        user_id: userId,
                        wx_avatar: wxAvatar,
                        wx_nickname: wxNickname,
                        role_type: roleType
                    };
                }
            });
            var storedUserArr = $("#windowContent1").find(".singleUserInfo1"),
                storedUserIdArr = [];
            storedUserArr.each(function () {
                var userId =  $(this).data("user_id");
                storedUserIdArr.push(userId);
            });

            var htmlStr = "";
            $.each(userArr, function(k, v) {
                if (storedUserIdArr.indexOf(k) == -1) {
                    htmlStr += getUserInfoItem(v);
                }
            });
            if (htmlStr.length>0) {
                $("#windowNoData1").remove();
                $("#windowContent1").append(htmlStr);
            }
            baseUtils.hideWindow("searchUserWindow");
            baseUtils.showWindow("roleManageWindow");

        });
    };
    function openRoleManageWindow(resType, roleListArr) {
        if (resType == 4) {
            baseUtils.show.redTip("直播类型不支持人员管理操作");
            return false;
        }
        baseUtils.showWindow("roleManageWindow");
        var htmlStr = "";
        $.each(roleListArr, function (k, v) {
            htmlStr += getUserInfoItem(v);
        });
        if (htmlStr.length == 0) {
            htmlStr =
                '<div class="windowNoData" id="windowNoData1">暂无老师和助教，请点击下方按钮快速添加人员</div>';
        }
        $("#windowContent1").html(htmlStr);

    }
    function openSearchUserWindow() {
        baseUtils.hideWindow("roleManageWindow");
        
        $("#searchUserWindow").find(".headerText1").text(
            ($exeBookList.addUserType==0)?"添加老师":"添加助教"
        );
        baseUtils.showWindow("searchUserWindow");
        
        $private.isSearchUserWindowToBottom = false;
        $private.userListPageIndex = 1;
        $private.userListSearchContent = "";
        getAllUserList();
    }
    function getUserInfoItem(v) {
        var htmlStr =
            '<div class="singleUserInfo1" data-user_id="'+v.user_id+'">'+
                '<img class="singleGuestAvatar1" src="'+v.wx_avatar+'">'+
                '<div class="singleGuestName1" title="'+v.wx_nickname+'">'+v.wx_nickname+'</div>'+
                '<div class="roleTypeRadioWrapper">'+
                    '<div class="roleTypeRadio">'+
                        '<span class="circleRadio '+(v.role_type==0?'radioActive':'')+'" data-role_type="0"></span><span>老师</span>'+
                    '</div>'+
                    '<div class="roleTypeRadio">'+
                        '<span class="circleRadio '+(v.role_type==1?'radioActive':'')+'" data-role_type="1"></span><span>助教</span>'+
                    '</div>'+
                '</div>'+
                '<div class="deleteSingleUser">删除</div>'+
            '</div>';
        return htmlStr;
    }
    function hasSetTeacher() {
        var hasSetTeacher = false,
            activeRadioArr = $("#windowContent1").find(".circleRadio.radioActive");

        activeRadioArr.each(function () {
            var roleType = $(this).data("role_type");
            if (roleType == 0) {
                hasSetTeacher = true;
                return false;
            }
        });

        return hasSetTeacher;
    }
    function getAllUserList() {
        baseUtils.showLoading("searchUserLoading");
        $private.isSearchUserWindowLoading = true;
        $.ajax("/zbsearch", {
            type: "GET",
            dataType: "json",
            data: {
                page: $private.userListPageIndex,
                search: $private.userListSearchContent
            },
            success: function (result) {
                baseUtils.hideLoading("searchUserLoading");
                $private.isSearchUserWindowLoading = false;

                var $area = $("#windowContent2"),
                    htmlStr = "",
                    offset = result.page_offset;

                $.each(result.data, function (k, v) {
                    htmlStr +=
                        '<div class="singleGuestInfo2" data-user_id="'+v.user_id+
                                '" data-wx_avatar="'+v.wx_avatar+'" data-wx_nickname="'+v.wx_nickname+'">'+
                            '<input type="checkbox" class="selectSingleGuest" id="'+v.user_id+'">'+
                            '<label for="'+v.user_id+'" class="singleGuestLabel">'+
                                '<img src="'+v.wx_avatar+'" class="singleGuestAvatar2">'+
                                '<div class="singleGuestName2" title="'+v.wx_nickname+'">'+v.wx_nickname+'</div>'+
                            '</label>'+
                        '</div>';
                });
                if (htmlStr.length == 0) {
                    htmlStr =
                        '<div class="windowNoData" id="windowNoData2">暂无数据</div>';
                }
                if ($private.userListPageIndex == 1) {
                    $area.html(htmlStr);
                    $area.append('<div class="isDown">更多数据加载中</div>');
                } else {
                    $area.find('.isDown').before(htmlStr);
                }
                if (offset.current_page >= offset.total_pages) {      //数据加载完毕后的操作
                    var timeRange = 0;
                    if (offset.total_count > 10) {
                        $area.find('.isDown').text("数据已加载完毕");
                        timeRange = 3000;
                    } else {
                        timeRange = 0;
                    }
                    setTimeout(function () {
                        $area.find('.isDown').hide();
                    }, timeRange);
                    $private.isSearchUserWindowToBottom = true;
                }
                $private.userListPageIndex ++;

            },
            error: function (xhr, status, err) {
                baseUtils.hideLoading("searchUserLoading");
                $private.isSearchUserWindowLoading = false;
                console.log(err);
                alert("服务器出小差了，请稍后再试！");
            }
        });
    };

    return $exeBookList;
})();



























